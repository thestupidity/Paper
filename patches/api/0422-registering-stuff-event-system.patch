From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Tue, 18 Jul 2023 14:47:02 -0700
Subject: [PATCH] registering stuff event system


diff --git a/src/main/java/io/papermc/paper/plugin/event/RegisterEvent.java b/src/main/java/io/papermc/paper/plugin/event/RegisterEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..e8fd963704e0530f1464fbfa7130f87c9f572bf0
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/RegisterEvent.java
@@ -0,0 +1,8 @@
+package io.papermc.paper.plugin.event;
+
+import org.jetbrains.annotations.ApiStatus;
+
+@ApiStatus.Experimental
+@ApiStatus.NonExtendable
+public interface RegisterEvent {
+}
diff --git a/src/main/java/io/papermc/paper/plugin/event/RegistrarEvent.java b/src/main/java/io/papermc/paper/plugin/event/RegistrarEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..b2f21f0d88cb67300f69f13582d8c98d9bf4e760
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/RegistrarEvent.java
@@ -0,0 +1,24 @@
+package io.papermc.paper.plugin.event;
+
+import org.jetbrains.annotations.ApiStatus;
+import org.jetbrains.annotations.NotNull;
+
+@ApiStatus.Experimental
+@ApiStatus.NonExtendable
+public interface RegistrarEvent<R extends ResourceRegistrar> extends RegisterEvent {
+
+    @NotNull R registrar();
+
+    @ApiStatus.Experimental
+    @ApiStatus.NonExtendable
+    interface Reloadable<R extends ResourceRegistrar> extends RegistrarEvent<R> {
+
+        @NotNull Cause cause();
+
+        @ApiStatus.Experimental
+        enum Cause {
+            INITIAL,
+            RELOAD
+        }
+    }
+}
diff --git a/src/main/java/io/papermc/paper/plugin/event/ResourceRegistrar.java b/src/main/java/io/papermc/paper/plugin/event/ResourceRegistrar.java
new file mode 100644
index 0000000000000000000000000000000000000000..19a2293b2c4d33e45b0dc8bb25790ecd84aee413
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/ResourceRegistrar.java
@@ -0,0 +1,12 @@
+package io.papermc.paper.plugin.event;
+
+import org.jetbrains.annotations.ApiStatus;
+
+/**
+ * To be implemented by types that provide ways to register types
+ * either on server start or during a reload
+ */
+@ApiStatus.Experimental
+@ApiStatus.NonExtendable
+public interface ResourceRegistrar {
+}
diff --git a/src/main/java/io/papermc/paper/plugin/event/dummy/DummyResourceRegistrar.java b/src/main/java/io/papermc/paper/plugin/event/dummy/DummyResourceRegistrar.java
new file mode 100644
index 0000000000000000000000000000000000000000..c989f73fff722aec159649bfd7b69cb7e90469fb
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/dummy/DummyResourceRegistrar.java
@@ -0,0 +1,6 @@
+package io.papermc.paper.plugin.event.dummy;
+
+import io.papermc.paper.plugin.event.ResourceRegistrar;
+
+public class DummyResourceRegistrar implements ResourceRegistrar {
+}
diff --git a/src/main/java/io/papermc/paper/plugin/event/dummy/NonRegistrarEvent.java b/src/main/java/io/papermc/paper/plugin/event/dummy/NonRegistrarEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..08b2058d97db892537e5d1533507a9e40236ad42
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/dummy/NonRegistrarEvent.java
@@ -0,0 +1,10 @@
+package io.papermc.paper.plugin.event.dummy;
+
+import io.papermc.paper.plugin.event.RegisterEvent;
+
+public class NonRegistrarEvent implements RegisterEvent {
+
+    public void someNonRegistrarRelatedThing() {
+        System.out.println("non registrar event");
+    }
+}
diff --git a/src/main/java/io/papermc/paper/plugin/event/hook/Hook.java b/src/main/java/io/papermc/paper/plugin/event/hook/Hook.java
new file mode 100644
index 0000000000000000000000000000000000000000..06d3a3e9937374d8202fb8c4aab144f6b45e037d
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/hook/Hook.java
@@ -0,0 +1,10 @@
+package io.papermc.paper.plugin.event.hook;
+
+import io.papermc.paper.plugin.event.RegisterEvent;
+import org.jetbrains.annotations.NotNull;
+
+@FunctionalInterface
+public interface Hook<E extends RegisterEvent> {
+
+    void run(@NotNull E event);
+}
diff --git a/src/main/java/io/papermc/paper/plugin/event/hook/RegisterHook.java b/src/main/java/io/papermc/paper/plugin/event/hook/RegisterHook.java
new file mode 100644
index 0000000000000000000000000000000000000000..24a7d2aceb37379d15a1bd22826f1d0058a48363
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/hook/RegisterHook.java
@@ -0,0 +1,11 @@
+package io.papermc.paper.plugin.event.hook;
+
+import io.papermc.paper.plugin.event.RegisterEvent;
+import org.jetbrains.annotations.ApiStatus;
+import org.jetbrains.annotations.NotNull;
+
+@ApiStatus.Experimental
+public sealed interface RegisterHook<O, E extends RegisterEvent> permits RegisterHookImpl {
+
+    void add(@NotNull O owner, @NotNull Hook<? super E> hook);
+}
diff --git a/src/main/java/io/papermc/paper/plugin/event/hook/RegisterHookImpl.java b/src/main/java/io/papermc/paper/plugin/event/hook/RegisterHookImpl.java
new file mode 100644
index 0000000000000000000000000000000000000000..81a368977db64bcf18f7286243be1202dc896055
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/hook/RegisterHookImpl.java
@@ -0,0 +1,31 @@
+package io.papermc.paper.plugin.event.hook;
+
+import io.papermc.paper.plugin.configuration.PluginMeta;
+import io.papermc.paper.plugin.event.RegisterEvent;
+import java.util.ArrayList;
+import java.util.List;
+import java.util.function.Function;
+import org.jetbrains.annotations.ApiStatus;
+
+@ApiStatus.Internal
+final class RegisterHookImpl<O, E extends RegisterEvent> implements RegisterHook<O, E> {
+
+    final String name;
+    final List<RegisteredHook<O, E>> hooks = new ArrayList<>();
+    final Function<? super O, PluginMeta> getPluginMeta;
+
+    RegisterHookImpl(final String name, final Function<? super O, PluginMeta> getPluginMeta) {
+        this.name = name;
+        this.getPluginMeta = getPluginMeta;
+    }
+
+    @Override
+    public void add(final O owner, final Hook<? super E> hook) {
+        this.hooks.add(new RegisteredHook<>(owner, hook));
+    }
+
+    @ApiStatus.Internal
+    record RegisteredHook<O, E extends RegisterEvent>(O owner, Hook<? super E> hook) {
+    }
+
+}
diff --git a/src/main/java/io/papermc/paper/plugin/event/hook/RegisterHooks.java b/src/main/java/io/papermc/paper/plugin/event/hook/RegisterHooks.java
new file mode 100644
index 0000000000000000000000000000000000000000..8eaa9b3a11503cb31720a13c400e053ded57ba03
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/hook/RegisterHooks.java
@@ -0,0 +1,33 @@
+package io.papermc.paper.plugin.event.hook;
+
+import io.papermc.paper.plugin.bootstrap.BootstrapContext;
+import io.papermc.paper.plugin.configuration.PluginMeta;
+import io.papermc.paper.plugin.event.RegisterEvent;
+import io.papermc.paper.plugin.event.RegistrarEvent;
+import io.papermc.paper.plugin.event.dummy.DummyResourceRegistrar;
+import io.papermc.paper.plugin.event.dummy.NonRegistrarEvent;
+import java.util.ArrayList;
+import java.util.List;
+import java.util.function.Function;
+import org.bukkit.plugin.java.JavaPlugin;
+import org.jetbrains.annotations.ApiStatus;
+
+@ApiStatus.Experimental
+public final class RegisterHooks {
+
+    static final List<RegisterHookImpl<?, ?>> ALL_HOOKS = new ArrayList<>();
+
+    public static final RegisterHook<BootstrapContext, RegistrarEvent.Reloadable<DummyResourceRegistrar>> DUMMY = create("dummy", BootstrapContext::getConfiguration);
+    public static final RegisterHook<JavaPlugin, RegistrarEvent<DummyResourceRegistrar>> DUMMY_STATIC = create("dummy_static", JavaPlugin::getPluginMeta);
+    public static final RegisterHook<BootstrapContext, NonRegistrarEvent> NON_REGISTRAR_RELATED_EVENT = create("non_registrar", BootstrapContext::getConfiguration);
+
+    @ApiStatus.Internal
+    private static <O, E extends RegisterEvent> RegisterHook<O, E> create(final String name, final Function<O, PluginMeta> getPluginMeta) {
+        final RegisterHookImpl<O, E> registerHookType = new RegisterHookImpl<>(name, getPluginMeta);
+        ALL_HOOKS.add(registerHookType);
+        return registerHookType;
+    }
+
+    private RegisterHooks() {
+    }
+}
diff --git a/src/main/java/io/papermc/paper/plugin/event/hook/package-info.java b/src/main/java/io/papermc/paper/plugin/event/hook/package-info.java
new file mode 100644
index 0000000000000000000000000000000000000000..ad5e26fcd1de96b9404b2c92572a235bb7159f4c
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/hook/package-info.java
@@ -0,0 +1,5 @@
+@DefaultQualifier(NonNull.class)
+package io.papermc.paper.plugin.event.hook;
+
+import org.checkerframework.checker.nullness.qual.NonNull;
+import org.checkerframework.framework.qual.DefaultQualifier;
diff --git a/src/main/java/io/papermc/paper/plugin/event/package-info.java b/src/main/java/io/papermc/paper/plugin/event/package-info.java
new file mode 100644
index 0000000000000000000000000000000000000000..2089570e3bd508e3d705a1d903ef17d2f0000b08
--- /dev/null
+++ b/src/main/java/io/papermc/paper/plugin/event/package-info.java
@@ -0,0 +1,9 @@
+/**
+ * A separate event system meant for registering values
+ * in both the bootstrap and regular plugin contexts.
+ */
+@DefaultQualifier(NonNull.class)
+package io.papermc.paper.plugin.event;
+
+import org.checkerframework.checker.nullness.qual.NonNull;
+import org.checkerframework.framework.qual.DefaultQualifier;
